Backend: medical_consultation:
#Consultation app:{
1)admin.py:
from django.contrib import admin
from .models import Clinic, Patient, Consultation, Appointment


@admin.register(Clinic)
class ClinicAdmin(admin.ModelAdmin):
    list_display = ("clinic_id", "name")
    search_fields = ("clinic_id", "name")
    ordering = ("name",)


@admin.register(Patient)
class PatientAdmin(admin.ModelAdmin):
    list_display = ("patient_id", "full_name", "clinic")
    search_fields = ("patient_id", "full_name")
    list_filter = ("clinic",)
    ordering = ("full_name",)


@admin.register(Consultation)
class ConsultationAdmin(admin.ModelAdmin):
    list_display = (
        "id",
        "patient",
        "clinic",
        "doctor",
        "status",
        "created_at",
    )
    list_filter = ("status", "clinic", "doctor")
    search_fields = (
        "patient__patient_id",
        "patient__full_name",
        "doctor__username",
    )
    readonly_fields = ("created_at", "updated_at")
    ordering = ("-created_at",)


@admin.register(Appointment)
class AppointmentAdmin(admin.ModelAdmin):
    list_display = (
        "room_id",
        "doctor",
        "patient",
        "clinic",
        "status",
        "start_time",
    )
    list_filter = ("status", "clinic", "doctor")
    search_fields = (
        "room_id",
        "patient__patient_id",
        "doctor__username",
    )
    readonly_fields = ("room_id", "start_time")
    ordering = ("-start_time",)
2)consumers.py:
from channels.generic.websocket import AsyncWebsocketConsumer
import json

class CallConsumer(AsyncWebsocketConsumer):
    async def connect(self):
        self.room_name = self.scope["url_route"]["kwargs"]["room"]
        self.room_group_name = f"call_{self.room_name}"

        await self.channel_layer.group_add(
            self.room_group_name,
            self.channel_name
        )
        await self.accept()

    async def disconnect(self, close_code):
        await self.channel_layer.group_discard(
            self.room_group_name,
            self.channel_name
        )

    async def receive(self, text_data):
        data = json.loads(text_data)
        # We broadcast the data as the 'payload'
        await self.channel_layer.group_send(
            self.room_group_name,
            {
                "type": "signal_message",
                "payload": data,
                "sender": self.channel_name,
            }
        )

    async def signal_message(self, event):
        # Do not send back to the person who sent it
        if self.channel_name == event["sender"]:
            return

        # Send the actual payload to the frontend
        await self.send(text_data=json.dumps(event["payload"]))
3)models.py:

from django.db import models
from django.contrib.auth.models import User
import uuid


class Clinic(models.Model):
    clinic_id = models.CharField(max_length=50, unique=True)
    name = models.CharField(max_length=100)

    def __str__(self):
        return f"{self.name} ({self.clinic_id})"


class Patient(models.Model):
    patient_id = models.CharField(max_length=50, unique=True)
    full_name = models.CharField(max_length=100, null=True, blank=True)
    clinic = models.ForeignKey(
        Clinic,
        on_delete=models.CASCADE,
        null=True,
        blank=True
    )

    def __str__(self):
        return f"{self.full_name} ({self.patient_id})"


class Consultation(models.Model):
    STATUS_CHOICES = [
        ("active", "Active"),
        ("completed", "Completed"),
        ("cancelled", "Cancelled"),
    ]

    doctor = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name="consultations",
        null=True,
        blank=True
    )

    clinic = models.ForeignKey(
        Clinic,
        on_delete=models.CASCADE,
        related_name="consultations"
    )

    patient = models.ForeignKey(
        Patient,
        on_delete=models.CASCADE,
        related_name="consultations"
    )

    notes = models.TextField(max_length=2000, blank=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="active")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.patient.patient_id} - {self.status}"


class Appointment(models.Model):
    doctor = models.ForeignKey(User, on_delete=models.CASCADE, related_name="doctor_appointments")
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    clinic = models.ForeignKey(Clinic, on_delete=models.CASCADE)

    consultation = models.OneToOneField(
        "Consultation",
        on_delete=models.CASCADE,
        related_name="appointment",
        null=True,
        blank=True
    )

    room_id = models.CharField(max_length=120, unique=True, blank=True)
    start_time = models.DateTimeField(auto_now_add=True)
    status = models.CharField(max_length=20, default="scheduled")

    def save(self, *args, **kwargs):
        if not self.room_id:
            self.room_id = f"consult-{uuid.uuid4()}"
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.room_id} - {self.status}"
4)routing.py:

from django.db import models
from django.contrib.auth.models import User
import uuid


class Clinic(models.Model):
    clinic_id = models.CharField(max_length=50, unique=True)
    name = models.CharField(max_length=100)

    def __str__(self):
        return f"{self.name} ({self.clinic_id})"


class Patient(models.Model):
    patient_id = models.CharField(max_length=50, unique=True)
    full_name = models.CharField(max_length=100, null=True, blank=True)
    clinic = models.ForeignKey(
        Clinic,
        on_delete=models.CASCADE,
        null=True,
        blank=True
    )

    def __str__(self):
        return f"{self.full_name} ({self.patient_id})"


class Consultation(models.Model):
    STATUS_CHOICES = [
        ("active", "Active"),
        ("completed", "Completed"),
        ("cancelled", "Cancelled"),
    ]

    doctor = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name="consultations",
        null=True,
        blank=True
    )

    clinic = models.ForeignKey(
        Clinic,
        on_delete=models.CASCADE,
        related_name="consultations"
    )

    patient = models.ForeignKey(
        Patient,
        on_delete=models.CASCADE,
        related_name="consultations"
    )

    notes = models.TextField(max_length=2000, blank=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default="active")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.patient.patient_id} - {self.status}"


class Appointment(models.Model):
    doctor = models.ForeignKey(User, on_delete=models.CASCADE, related_name="doctor_appointments")
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    clinic = models.ForeignKey(Clinic, on_delete=models.CASCADE)

    consultation = models.OneToOneField(
        "Consultation",
        on_delete=models.CASCADE,
        related_name="appointment",
        null=True,
        blank=True
    )

    room_id = models.CharField(max_length=120, unique=True, blank=True)
    start_time = models.DateTimeField(auto_now_add=True)
    status = models.CharField(max_length=20, default="scheduled")

    def save(self, *args, **kwargs):
        if not self.room_id:
            self.room_id = f"consult-{uuid.uuid4()}"
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.room_id} - {self.status}"
6)serializers.py:
"""
consultation/serializers.py
"""

from rest_framework import serializers
from .models import Clinic, Patient, Consultation, Appointment


class SpeechToTextSerializer(serializers.Serializer):
    audio = serializers.FileField()
    appointment_id = serializers.IntegerField()


class ClinicSerializer(serializers.ModelSerializer):
    class Meta:
        model = Clinic
        fields = "__all__"


class PatientSerializer(serializers.ModelSerializer):
    class Meta:
        model = Patient
        fields = "__all__"


class ConsultationSerializer(serializers.ModelSerializer):
    class Meta:
        model = Consultation
        fields = "__all__"


class AppointmentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Appointment
        fields = "__all__"
7)urls.py:
"""
consultation/urls.py
"""

from django.urls import path
from .views import *

urlpatterns = [
    path("speech-to-text/", speech_to_text),
    path("clinics/", get_clinics),
    path("create-clinic/", create_clinic),
    path("create-patient/", create_patient),
    path("patients/<int:clinic_id>/", get_patients_by_clinic),
    path("start-consultation/", start_consultation),
    path("end-consultation/", end_consultation),
    path("save-notes/", save_notes),
]
8)views.py:
"""
consultation/views.py
"""

from rest_framework.decorators import api_view, parser_classes, permission_classes
from rest_framework.parsers import MultiPartParser, FormParser
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from django.shortcuts import get_object_or_404
from .models import Patient, Consultation, Clinic, Appointment
from .serializers import SpeechToTextSerializer
from rest_framework_simplejwt.tokens import RefreshToken
from django.contrib.auth import authenticate
import tempfile
import os
import subprocess
import whisper

# Load Whisper Model
whisper_model = whisper.load_model("small")


# ==================== UTILITY FUNCTIONS ====================
def convert_to_wav(uploaded_file):
    """Convert audio file to WAV format"""
    suffix = os.path.splitext(uploaded_file.name)[1]

    with tempfile.NamedTemporaryFile(delete=False, suffix=suffix) as temp_input:
        for chunk in uploaded_file.chunks():
            temp_input.write(chunk)
        input_path = temp_input.name

    output_fd, output_path = tempfile.mkstemp(suffix=".wav")
    os.close(output_fd)

    subprocess.run(
        ["ffmpeg", "-y", "-i", input_path, output_path],
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        check=True,
    )

    os.remove(input_path)
    return output_path


def transcribe_audio(path):
    """Transcribe audio using Whisper"""
    result = whisper_model.transcribe(path)
    os.remove(path)
    return result.get("text", "").strip()


# ==================== SPEECH TO TEXT ====================
@api_view(["POST"])
@parser_classes([MultiPartParser, FormParser])
def speech_to_text(request):
    """Convert audio to text and save to consultation"""
    serializer = SpeechToTextSerializer(data=request.data)

    if not serializer.is_valid():
        return Response(serializer.errors, status=400)

    try:
        audio_file = serializer.validated_data["audio"]
        appointment_id = serializer.validated_data["appointment_id"]

        # Convert and transcribe
        wav_path = convert_to_wav(audio_file)
        text = transcribe_audio(wav_path)

        # Save to consultation
        appointment = Appointment.objects.get(id=appointment_id)
        if appointment.consultation:
            consultation = appointment.consultation
            consultation.notes += f"\n{text}"
            consultation.save()

        return Response({"text": text}, status=200)

    except Exception as e:
        return Response({"error": str(e)}, status=500)


# ==================== CLINICS ====================
@api_view(["GET"])
def get_clinics(request):
    """Get all clinics"""
    clinics = Clinic.objects.all()
    return Response([{"id": c.id, "name": c.name, "clinic_id": c.clinic_id} for c in clinics])


@api_view(["POST"])
@permission_classes([IsAuthenticated])
def create_clinic(request):
    """Create new clinic (Admin only)"""
    if not request.user.is_staff:
        return Response({"error": "Admin only"}, status=403)

    name = request.data.get("name")
    clinic_id = request.data.get("clinic_id")

    if not name or not clinic_id:
        return Response({"error": "name and clinic_id required"}, status=400)

    if Clinic.objects.filter(clinic_id=clinic_id).exists():
        return Response({"error": "clinic_id already exists"}, status=400)

    clinic = Clinic.objects.create(name=name, clinic_id=clinic_id)
    return Response({"id": clinic.id, "name": clinic.name, "clinic_id": clinic.clinic_id}, status=201)


# ==================== PATIENTS ====================
@api_view(["GET"])
def get_patients_by_clinic(request, clinic_id):
    """Get patients by clinic ID"""
    patients = Patient.objects.filter(clinic_id=clinic_id)
    return Response([{"id": p.id, "full_name": p.full_name, "patient_id": p.patient_id} for p in patients])


@api_view(["POST"])
@permission_classes([IsAuthenticated])
def create_patient(request):
    """Create new patient (Admin only)"""
    if not request.user.is_staff:
        return Response({"error": "Admin only"}, status=403)

    clinic_id = request.data.get("clinic")
    full_name = request.data.get("full_name")
    patient_id = request.data.get("patient_id")

    if not clinic_id or not full_name or not patient_id:
        return Response({"error": "clinic, full_name, patient_id required"}, status=400)

    if Patient.objects.filter(patient_id=patient_id).exists():
        return Response({"error": "patient_id already exists"}, status=400)

    clinic = Clinic.objects.get(id=clinic_id)
    patient = Patient.objects.create(
        clinic=clinic,
        full_name=full_name,
        patient_id=patient_id
    )

    return Response({
        "id": patient.id,
        "full_name": patient.full_name,
        "patient_id": patient.patient_id
    }, status=201)


# ==================== CONSULTATION ====================
@api_view(["POST"])
@permission_classes([IsAuthenticated])
def start_consultation(request):
    """Start a new consultation"""
    clinic_id = request.data.get("clinic")
    patient_id = request.data.get("patient")

    clinic = get_object_or_404(Clinic, id=clinic_id)
    patient = get_object_or_404(Patient, id=patient_id)

    # Create appointment
    appointment = Appointment.objects.create(
        doctor=request.user,
        clinic=clinic,
        patient=patient,
        status="active"
    )

    # Create consultation
    consultation = Consultation.objects.create(
        doctor=request.user,
        clinic=clinic,
        patient=patient,
        status="active"
    )

    # Link them
    appointment.consultation = consultation
    appointment.save()

    return Response({
        "appointment_id": appointment.id,
        "consultation_id": consultation.id,
        "room_id": appointment.room_id,
        "patient_url": f"http://localhost:3000/patient/{appointment.room_id}"
    })


@api_view(["POST"])
@permission_classes([IsAuthenticated])
def end_consultation(request):
    """End consultation"""
    consultation_id = request.data.get("consultation_id")
    consultation = get_object_or_404(Consultation, id=consultation_id)
    
    consultation.status = "completed"
    consultation.save()
    
    return Response({"status": "ended"})


@api_view(["POST"])
@permission_classes([IsAuthenticated])
def save_notes(request):
    """Save consultation notes"""
    consultation_id = request.data.get("consultation")
    notes = request.data.get("notes")

    consultation = get_object_or_404(Consultation, id=consultation_id)

    if notes:
        consultation.notes = notes
        consultation.save()

    return Response({"status": "saved", "notes": consultation.notes})

@api_view(['POST'])
def login_view(request):
    username = request.data.get('username')
    password = request.data.get('password')

    user = authenticate(username=username, password=password)

    if user is None:
        return Response({"error": "Invalid credentials"}, status=401)

    refresh = RefreshToken.for_user(user)

    return Response({
        "access": str(refresh.access_token),
        "refresh": str(refresh),
        "is_superuser": user.is_superuser,
        "is_staff": user.is_staff,
        "username": user.username
    })
}end of consultation app.

#medical_consultation main app:{
1)settings.py:
"""
Django settings for medical_consultation project.

Generated by 'django-admin startproject' using Django 6.0.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/6.0/ref/settings/
"""
"""
medical_consultation/settings.py
"""

from pathlib import Path
from datetime import timedelta

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = 'django-insecure-your-secret-key-here'

DEBUG = True

ALLOWED_HOSTS = []

INSTALLED_APPS = [
    'daphne',  
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions', 
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'channels',
    'consultation',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'medical_consultation.urls'

CORS_ALLOW_ALL_ORIGINS = True

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'medical_consultation.wsgi.application'
ASGI_APPLICATION = 'medical_consultation.asgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True

STATIC_URL = 'static/'
MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Channels
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels.layers.InMemoryChannelLayer"
    }
}

# JWT
REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": (
        "rest_framework_simplejwt.authentication.JWTAuthentication",
    )
}

SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(hours=5),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=1),
}
2)asgi.py:
"""
medical_consultation/asgi.py
"""

import os
import django
from channels.routing import ProtocolTypeRouter, URLRouter
from django.core.asgi import get_asgi_application
from channels.auth import AuthMiddlewareStack
import consultation.routing

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'medical_consultation.settings')

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(
            consultation.routing.websocket_urlpatterns
        )
    ),
})
3)urls.py
"""
medical_consultation/asgi.py
"""

import os
import django
from channels.routing import ProtocolTypeRouter, URLRouter
from django.core.asgi import get_asgi_application
from channels.auth import AuthMiddlewareStack
import consultation.routing

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'medical_consultation.settings')

application = ProtocolTypeRouter({
    "http": get_asgi_application(),
    "websocket": AuthMiddlewareStack(
        URLRouter(
            consultation.routing.websocket_urlpatterns
        )
    ),
})

}end of medical_consultation app.
